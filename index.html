<!DOCTYPE html>
<html>
<head>
    <title></title>

    <!-- Mapbox -->

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>

    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />


    <!-- Google Places -->

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPv7VFQeI_dNWfE-Y8IXIywMzEzSkNd28&libraries=places"></script>

</head>
<body>

<div id='map' style='width: 100%; height: 1080px;'></div>

<script>

    // Variables

    var userCoordinates;    // User's coordinates

    var searchOptions;      // Search options: 0 = no filter ; 1 = Bars ; 2 = Restaurants

    var map;                // The map generated by mapbox

    var userPositionMarker; // Marker associated with user's location

    var placesRequest;      // Google places API request

    var placeInformations;  // Informations about places: contains ID, latitude and longitude, adress, rating, name, etc...

    var JSONSaveFileName;   // Name of the JSON data file

    var JSONFile;           // File that store JSON data

    // Initialisation of user's location with coordinates of Lyon

    userCoordinates = {

        userLatitude : 45.75717800533178,

        userLongitude : 4.83480298193669

    }

    // Update user's location

    getUserLocation();

    // Mapbox generation with API key authentication

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWd0ZXJyYWwiLCJhIjoiY2pkMjRnbjJkNWYwZDJ4bGdwMWlxODJiYSJ9.4W9g-Go5vHpL9UZmjnGj4g';

    map = new mapboxgl.Map({

        container: 'map',

        center: [ userCoordinates.userLongitude, userCoordinates.userLatitude ],

        zoom: 13,

        style: 'mapbox://styles/mapbox/streets-v9'

    });

    // Creation of user marker on map

    userPositionMarker = new mapboxgl.Marker().setLngLat([userCoordinates.userLongitude, userCoordinates.userLatitude]).addTo(map);

    // Basic places request with bars and restaurants

    searchOptions = 0;

    updateJSONDataFile();

    //Functions

    // getUserLocation : retrieves the user's location and watch location changes

    function getUserLocation()
    {

        if( navigator.geolocation )
        {

            navigator.geolocation.watchPosition(setUserCoordinates);

        }

    }

    // setUserCoordinates : fix the userCoordinates properties, center the map on the user's location and update the marker

    function setUserCoordinates(position) {

        userCoordinates.userLatitude = position.coords.latitude;

        userCoordinates.userLongitude = position.coords.longitude;

        map.setCenter([userCoordinates.userLongitude, userCoordinates.userLatitude]);

        userPositionMarker.setLngLat([userCoordinates.userLongitude, userCoordinates.userLatitude]);

    }

    // updateJSONDataFile : update the JSON data file with nearby places

    function updateJSONDataFile()
    {

        var location = new google.maps.LatLng(userCoordinates.userLatitude, userCoordinates.userLongitude);

        placesRequest = {

            location: location,

            radius: '5000',

            type: 'bar'

        }

        service = new google.maps.places.PlacesService(document.createElement('div'));

        service.nearbySearch(placesRequest, callback);

    }

    function callback(results, status) {

        var bars = "{";

        if (status == google.maps.places.PlacesServiceStatus.OK) {

            for (var i = 0; i < results.length ; i++) {

                var actualPlace = results[i];

                placeInformations = {

                    "id" : actualPlace['place_id'],

                    "coordinates" : actualPlace['geometry']['location'],

                    "adress" : actualPlace['vicinity'],

                    "rating" : actualPlace['rating'],

                    "opened" : "unknown",

                    "name" : actualPlace ['name'],

                    "type" : 'bar',

                    //"photo" : actualPlace['photos']

                };

                if( actualPlace['opening_hours'] )
                    placeInformations.opened = actualPlace['opening_hours']['open_now'];

                if(i == results.length - 1)
                    bars += "{" + JSON.stringify(placeInformations) + "}";
                else
                    bars += "{" + JSON.stringify(placeInformations) + "},";

            }

        }

        bars += "}";

        console.log(bars);

        JSONSaveFileName = "JSONDataFile.txt";

        JSONFile = new File([bars], JSONSaveFileName);

        var blob = new Blob([bars], {type: "text/plain;charset=utf-8"});

       // saveAs(blob, JSONSaveFileName);

        var fileReader = new FileReader();

        console.log(fileReader.readAsText(JSONFile));

    }

    // Location button by mapbox

 /*   map.addControl( new mapboxgl.GeolocateControl ({

        positionOptions: {

            enableHighAccuracy: true

        },

        trackUserLocation: true

    }));*/

</script>


</body>
</html>